<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Determinanten-Rechner</title>
<style>
/* ═══════════════════════════════════════════════════════════════
   APPLE DESIGN SYSTEM – Determinanten-Rechner
   ═══════════════════════════════════════════════════════════════ */

:root {
  --system-blue: #007AFF;
  --system-green: #34C759;
  --system-indigo: #5856D6;
  --system-orange: #FF9500;
  --system-pink: #FF2D55;
  --system-purple: #AF52DE;
  --system-teal: #5AC8FA;
  --system-red: #FF3B30;
  --system-yellow: #FFCC00;

  --accent: #5856D6;
  --accent-soft: rgba(88, 86, 214, 0.10);

  --diag-pos-1: #007AFF;
  --diag-pos-2: #5856D6;
  --diag-pos-3: #AF52DE;
  --diag-neg-1: #FF3B30;
  --diag-neg-2: #FF9500;
  --diag-neg-3: #FF2D55;

  --bg-primary: #FFFFFF;
  --bg-secondary: #F5F5F7;
  --bg-tertiary: #FFFFFF;
  --bg-grouped: #F2F2F7;
  --text-primary: #000000;
  --text-secondary: #3A3A3C;
  --text-tertiary: #8E8E93;
  --separator: rgba(0, 0, 0, 0.08);
  --separator-strong: rgba(0, 0, 0, 0.16);

  --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
  --font-mono: "SF Mono", SFMono-Regular, ui-monospace, Menlo, Monaco, monospace;

  --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px;
  --space-5: 20px; --space-6: 24px; --space-8: 32px; --space-10: 40px;

  --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 20px;

  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);

  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #000000;
    --bg-secondary: #1C1C1E;
    --bg-tertiary: #2C2C2E;
    --bg-grouped: #1C1C1E;
    --text-primary: #FFFFFF;
    --text-secondary: #EBEBF5;
    --text-tertiary: #8E8E93;
    --separator: rgba(255, 255, 255, 0.12);
    --separator-strong: rgba(255, 255, 255, 0.24);

    --diag-pos-1: #64D2FF;
    --diag-pos-2: #BF5AF2;
    --diag-pos-3: #a78bfa;
    --diag-neg-1: #FF453A;
    --diag-neg-2: #FFD60A;
    --diag-neg-3: #FF375F;

    --accent: #a78bfa;
    --accent-soft: rgba(167, 139, 250, 0.12);

    --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
  }
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-stack);
  background: var(--bg-secondary);
  color: var(--text-primary);
  min-height: 100vh;
  padding: var(--space-6);
  -webkit-font-smoothing: antialiased;
}

.container { max-width: 900px; margin: 0 auto; }

/* ─── Header ─── */
.page-header {
  text-align: center;
  margin-bottom: var(--space-8);
  padding: var(--space-10) var(--space-6);
  background: var(--bg-primary);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
}

.page-header h1 {
  font-size: 2.2rem;
  font-weight: 600;
  letter-spacing: -0.02em;
  margin-bottom: var(--space-2);
}

.page-header p {
  font-size: 1.05rem;
  color: var(--text-tertiary);
}

/* ─── Size Toggle ─── */
.size-toggle {
  display: flex;
  gap: 0;
  background: var(--bg-grouped);
  border-radius: var(--radius-sm);
  padding: 3px;
  margin-bottom: var(--space-6);
  max-width: 240px;
  margin-left: auto;
  margin-right: auto;
}

.size-btn {
  flex: 1;
  padding: var(--space-2) var(--space-4);
  background: transparent;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-family: var(--font-stack);
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text-tertiary);
  transition: all var(--transition-fast);
}

.size-btn.active {
  background: var(--bg-primary);
  color: var(--text-primary);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* ─── Card ─── */
.card {
  background: var(--bg-primary);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
  padding: var(--space-8);
  margin-bottom: var(--space-6);
}

.card-header {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-tertiary);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: var(--space-4);
}

/* ─── Matrix Input ─── */
.matrix-area {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-4);
  margin-bottom: var(--space-6);
}

.matrix-bracket {
  font-size: 4.5rem;
  font-weight: 200;
  color: var(--text-tertiary);
  line-height: 1;
  user-select: none;
}

.matrix-bracket.size-2 { font-size: 3rem; }

.matrix-grid-3 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space-2);
}

.matrix-grid-2 {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--space-2);
}

.matrix-cell {
  width: 64px;
  height: 56px;
  background: var(--bg-grouped);
  border: 1.5px solid var(--separator);
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: 1.15rem;
  font-weight: 500;
  text-align: center;
  color: var(--text-primary);
  transition: all 0.3s ease;
  -moz-appearance: textfield;
}

.matrix-cell::-webkit-outer-spin-button,
.matrix-cell::-webkit-inner-spin-button {
  -webkit-appearance: none; margin: 0;
}

.matrix-cell:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-soft);
}

.matrix-cell.highlight {
  transform: scale(1.08);
  z-index: 2;
  position: relative;
}

/* ─── Presets ─── */
.presets {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  justify-content: center;
  margin-bottom: var(--space-6);
}

.preset-btn {
  padding: var(--space-2) var(--space-3);
  background: var(--bg-grouped);
  border: 1px solid var(--separator);
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 0.78rem;
  font-family: var(--font-stack);
  font-weight: 500;
  color: var(--text-secondary);
  transition: all var(--transition-fast);
}

.preset-btn:hover {
  background: var(--accent-soft);
  border-color: var(--accent);
  color: var(--accent);
}

.preset-btn:active { transform: scale(0.97); }

/* ─── Sarrus Visualization ─── */
.sarrus-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-6);
  margin: var(--space-6) 0;
}

.sarrus-grid-wrapper {
  position: relative;
  display: flex;
  justify-content: center;
}

.sarrus-canvas {
  border-radius: var(--radius-md);
}

/* ─── Steps ─── */
.steps-container {
  width: 100%;
}

.step {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-sm);
  margin-bottom: var(--space-2);
  background: var(--bg-grouped);
  opacity: 0.4;
  transition: all 0.4s ease;
  font-family: var(--font-mono);
  font-size: 0.88rem;
}

.step.active {
  opacity: 1;
  transform: translateX(4px);
}

.step-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.step-sign {
  font-weight: 700;
  width: 16px;
  text-align: center;
  flex-shrink: 0;
}

.step-calc {
  flex: 1;
  color: var(--text-secondary);
}

.step-result {
  font-weight: 600;
  color: var(--text-primary);
  min-width: 60px;
  text-align: right;
}

/* ─── Result ─── */
.result-box {
  text-align: center;
  padding: var(--space-6);
  background: var(--bg-grouped);
  border-radius: var(--radius-md);
  margin-top: var(--space-4);
}

.result-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-tertiary);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: var(--space-2);
}

.result-value {
  font-family: var(--font-mono);
  font-size: 2.4rem;
  font-weight: 600;
  transition: color 0.3s ease;
}

.result-positive { color: var(--system-green); }
.result-negative { color: var(--system-red); }
.result-zero { color: var(--system-orange); }

.result-interpretation {
  font-size: 0.85rem;
  color: var(--text-tertiary);
  margin-top: var(--space-2);
}

/* ─── Animate Button ─── */
.animate-btn {
  display: block;
  width: 100%;
  max-width: 300px;
  margin: var(--space-4) auto 0;
  padding: var(--space-3) var(--space-4);
  background: var(--accent);
  color: #FFFFFF;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  font-family: var(--font-stack);
  transition: all var(--transition-fast);
}

.animate-btn:hover { opacity: 0.85; }
.animate-btn:active { transform: scale(0.98); }
.animate-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ─── Explanation ─── */
.explanation {
  background: var(--bg-primary);
  padding: var(--space-8);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--system-indigo);
  margin-bottom: var(--space-6);
}

.explanation h2 {
  font-size: 1.4rem;
  font-weight: 600;
  letter-spacing: -0.02em;
  margin-bottom: var(--space-4);
}

.explanation p {
  color: var(--text-secondary);
  line-height: 1.8;
  margin-bottom: var(--space-4);
  font-size: 0.95rem;
}

.explanation ul {
  margin-left: var(--space-6);
  color: var(--text-secondary);
  line-height: 1.8;
}

.explanation li {
  margin-bottom: var(--space-2);
  font-size: 0.95rem;
}

.explanation li strong { color: var(--text-primary); }

.color-swatch {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 3px;
  margin-right: 4px;
  vertical-align: middle;
}

.back-link {
  display: inline-block;
  margin-top: var(--space-6);
  font-size: 0.9rem;
  color: var(--system-blue);
  text-decoration: none;
  transition: opacity var(--transition-fast);
}

.back-link:hover { opacity: 0.7; }

/* ─── 2x2 Formula ─── */
.formula-2x2 {
  text-align: center;
  font-family: var(--font-mono);
  font-size: 1rem;
  color: var(--text-secondary);
  padding: var(--space-4);
  background: var(--bg-grouped);
  border-radius: var(--radius-md);
  margin: var(--space-4) 0;
  line-height: 1.8;
}

/* ─── Responsive ─── */
@media (max-width: 768px) {
  body { padding: var(--space-4); }
  .page-header { padding: var(--space-6) var(--space-4); }
  .page-header h1 { font-size: 1.6rem; }
  .card { padding: var(--space-5); }
  .matrix-cell { width: 54px; height: 48px; font-size: 1rem; }
  .matrix-bracket { font-size: 3.5rem; }
  .matrix-bracket.size-2 { font-size: 2.5rem; }
  .result-value { font-size: 1.8rem; }
}

@media (max-width: 480px) {
  body { padding: var(--space-3); }
  .page-header h1 { font-size: 1.4rem; }
  .matrix-cell { width: 48px; height: 44px; font-size: 0.95rem; }
  .matrix-bracket { font-size: 2.8rem; }
  .step { font-size: 0.78rem; padding: var(--space-2) var(--space-3); }
  .step-result { min-width: 45px; }
}
</style>
</head>
<body>
<div class="container">

  <div class="page-header">
    <h1>Determinanten-Rechner</h1>
    <p>Sarrus-Regel Schritt für Schritt visualisiert</p>
  </div>

  <!-- Size Toggle -->
  <div class="size-toggle">
    <button class="size-btn" id="btn2x2" onclick="setSize(2)">2 × 2</button>
    <button class="size-btn active" id="btn3x3" onclick="setSize(3)">3 × 3</button>
  </div>

  <!-- Main Card -->
  <div class="card">
    <div class="card-header">Matrix eingeben</div>

    <!-- Matrix Input -->
    <div class="matrix-area" id="matrixArea">
      <!-- Filled by JS -->
    </div>

    <!-- Presets -->
    <div class="presets" id="presets">
      <!-- Filled by JS -->
    </div>

    <!-- Animate -->
    <button class="animate-btn" id="animateBtn" onclick="animateSarrus()">Sarrus-Regel animieren</button>

    <!-- Sarrus Visualization -->
    <div class="sarrus-container" id="sarrusContainer">
      <canvas id="sarrusCanvas" class="sarrus-canvas"></canvas>
      <div class="steps-container" id="stepsContainer"></div>
    </div>

    <!-- Result -->
    <div class="result-box">
      <div class="result-label">Determinante</div>
      <div class="result-value" id="resultValue">0</div>
      <div class="result-interpretation" id="resultInterp"></div>
    </div>
  </div>

  <!-- Explanation -->
  <div class="explanation">
    <h2>Wie funktioniert die Sarrus-Regel?</h2>
    <p>
      Die Sarrus-Regel berechnet die Determinante einer <strong>3×3-Matrix</strong>.
      Man kopiert die ersten zwei Spalten rechts neben die Matrix und bildet dann sechs Diagonalprodukte.
    </p>
    <ul>
      <li><span class="color-swatch" style="background: var(--diag-pos-1);"></span><span class="color-swatch" style="background: var(--diag-pos-2);"></span><span class="color-swatch" style="background: var(--diag-pos-3);"></span> <strong>Hauptdiagonalen</strong> (↘) — diese drei Produkte werden <strong>addiert</strong></li>
      <li><span class="color-swatch" style="background: var(--diag-neg-1);"></span><span class="color-swatch" style="background: var(--diag-neg-2);"></span><span class="color-swatch" style="background: var(--diag-neg-3);"></span> <strong>Nebendiagonalen</strong> (↙) — diese drei Produkte werden <strong>subtrahiert</strong></li>
    </ul>
    <p>
      <strong>Merke:</strong> det(A) = 0 bedeutet, die Matrix ist singulär (nicht invertierbar).
      Für 2×2-Matrizen gilt einfach: det = a·d − b·c.
    </p>
  </div>

  <a href="/teaching/mathematik/" class="back-link">← Zurück zur Mathematik-Übersicht</a>

</div>

<script>
// ─── State ───
let matrixSize = 3;
let values3 = [2, 1, 3, 0, -1, 2, 4, 0, 1];
let values2 = [3, 2, 1, 4];
let animating = false;
let activeStep = -1;

const presets3 = [
  { name: 'Einheitsmatrix', v: [1,0,0, 0,1,0, 0,0,1] },
  { name: 'det = 0', v: [1,2,3, 4,5,6, 7,8,9] },
  { name: 'Dreiecksmatrix', v: [2,3,1, 0,4,5, 0,0,3] },
  { name: 'Beispiel 1', v: [2,1,3, 0,-1,2, 4,0,1] },
  { name: 'Beispiel 2', v: [1,2,0, 3,1,-1, 2,0,4] },
  { name: 'Große Zahlen', v: [5,3,7, 2,4,1, 6,8,9] },
];

const presets2 = [
  { name: 'Einheitsmatrix', v: [1,0, 0,1] },
  { name: 'det = 0', v: [2,4, 1,2] },
  { name: 'Beispiel 1', v: [3,2, 1,4] },
  { name: 'Beispiel 2', v: [5,-3, 2,7] },
];

function css(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

// ─── Build UI ───
function buildUI() {
  buildMatrixInput();
  buildPresets();
  updateCalculation();
}

function buildMatrixInput() {
  const area = document.getElementById('matrixArea');
  const n = matrixSize;
  const vals = n === 3 ? values3 : values2;
  const bracketClass = n === 2 ? 'matrix-bracket size-2' : 'matrix-bracket';

  let html = `<span class="${bracketClass}">(</span>`;
  html += `<div class="matrix-grid-${n}">`;
  for (let i = 0; i < n * n; i++) {
    html += `<input type="number" class="matrix-cell" id="cell${i}" value="${vals[i]}" step="1">`;
  }
  html += `</div>`;
  html += `<span class="${bracketClass}">)</span>`;

  area.innerHTML = html;

  // Attach listeners
  for (let i = 0; i < n * n; i++) {
    document.getElementById(`cell${i}`).addEventListener('input', () => {
      readValues();
      updateCalculation();
    });
  }
}

function buildPresets() {
  const container = document.getElementById('presets');
  const list = matrixSize === 3 ? presets3 : presets2;

  container.innerHTML = list.map((p, i) =>
    `<button class="preset-btn" onclick="applyPreset(${i})">${p.name}</button>`
  ).join('');
}

function readValues() {
  const n = matrixSize;
  const vals = [];
  for (let i = 0; i < n * n; i++) {
    vals.push(parseFloat(document.getElementById(`cell${i}`).value) || 0);
  }
  if (n === 3) values3 = vals;
  else values2 = vals;
}

function applyPreset(idx) {
  const list = matrixSize === 3 ? presets3 : presets2;
  const vals = list[idx].v;
  if (matrixSize === 3) values3 = [...vals];
  else values2 = [...vals];

  for (let i = 0; i < vals.length; i++) {
    document.getElementById(`cell${i}`).value = vals[i];
  }
  activeStep = -1;
  updateCalculation();
}

// ─── Size Toggle ───
function setSize(n) {
  matrixSize = n;
  document.getElementById('btn2x2').classList.toggle('active', n === 2);
  document.getElementById('btn3x3').classList.toggle('active', n === 3);

  document.getElementById('animateBtn').style.display = n === 3 ? 'block' : 'none';

  activeStep = -1;
  animating = false;
  buildUI();
}

// ─── Calculation ───
function getVal3(row, col) { return values3[row * 3 + col]; }
function getVal2(row, col) { return values2[row * 2 + col]; }

function compute3x3() {
  const m = getVal3;
  // Positive diagonals
  const p1 = m(0,0) * m(1,1) * m(2,2);
  const p2 = m(0,1) * m(1,2) * m(2,0);
  const p3 = m(0,2) * m(1,0) * m(2,1);
  // Negative diagonals
  const n1 = m(2,0) * m(1,1) * m(0,2);
  const n2 = m(2,1) * m(1,2) * m(0,0);
  const n3 = m(2,2) * m(1,0) * m(0,1);

  return {
    steps: [
      { sign: '+', cells: [[0,0],[1,1],[2,2]], factors: [m(0,0), m(1,1), m(2,2)], product: p1, color: '--diag-pos-1' },
      { sign: '+', cells: [[0,1],[1,2],[2,0]], factors: [m(0,1), m(1,2), m(2,0)], product: p2, color: '--diag-pos-2' },
      { sign: '+', cells: [[0,2],[1,0],[2,1]], factors: [m(0,2), m(1,0), m(2,1)], product: p3, color: '--diag-pos-3' },
      { sign: '−', cells: [[2,0],[1,1],[0,2]], factors: [m(2,0), m(1,1), m(0,2)], product: n1, color: '--diag-neg-1' },
      { sign: '−', cells: [[2,1],[1,2],[0,0]], factors: [m(2,1), m(1,2), m(0,0)], product: n2, color: '--diag-neg-2' },
      { sign: '−', cells: [[2,2],[1,0],[0,1]], factors: [m(2,2), m(1,0), m(0,1)], product: n3, color: '--diag-neg-3' },
    ],
    det: p1 + p2 + p3 - n1 - n2 - n3
  };
}

function compute2x2() {
  const a = values2[0], b = values2[1], c = values2[2], d = values2[3];
  return {
    ad: a * d,
    bc: b * c,
    det: a * d - b * c
  };
}

// ─── Update ───
function updateCalculation() {
  if (matrixSize === 3) {
    update3x3();
  } else {
    update2x2();
  }
}

function update3x3() {
  const result = compute3x3();

  // Steps
  const stepsEl = document.getElementById('stepsContainer');
  stepsEl.innerHTML = result.steps.map((s, i) => {
    const calcStr = s.factors.map(f => formatNum(f)).join(' · ');
    const isActive = activeStep === -1 || activeStep === i;
    return `
      <div class="step ${isActive ? 'active' : ''}" id="step${i}">
        <div class="step-dot" style="background: var(${s.color});"></div>
        <div class="step-sign" style="color: ${s.sign === '+' ? 'var(--system-green)' : 'var(--system-red)'};">${s.sign}</div>
        <div class="step-calc">${calcStr}</div>
        <div class="step-result">= ${formatNum(s.product)}</div>
      </div>
    `;
  }).join('');

  // Draw Sarrus canvas
  drawSarrus3x3(result);

  // Result
  updateResult(result.det);
}

function update2x2() {
  const result = compute2x2();
  const a = values2[0], b = values2[1], c = values2[2], d = values2[3];

  const stepsEl = document.getElementById('stepsContainer');
  stepsEl.innerHTML = `
    <div class="formula-2x2">
      det(A) = a·d − b·c<br>
      = ${formatNum(a)} · ${formatNum(d)} − ${formatNum(b)} · ${formatNum(c)}<br>
      = ${formatNum(result.ad)} − ${formatNum(result.bc)}<br>
      = <strong>${formatNum(result.det)}</strong>
    </div>
  `;

  // Hide sarrus canvas for 2x2
  const canvas = document.getElementById('sarrusCanvas');
  canvas.width = 0;
  canvas.height = 0;

  updateResult(result.det);
}

function updateResult(det) {
  const el = document.getElementById('resultValue');
  el.textContent = formatNum(det);
  el.className = 'result-value ' + (det > 0.001 ? 'result-positive' : det < -0.001 ? 'result-negative' : 'result-zero');

  const interp = document.getElementById('resultInterp');
  if (Math.abs(det) < 0.001) {
    interp.textContent = 'Singulär — Matrix nicht invertierbar';
  } else if (det > 0) {
    interp.textContent = 'Regulär — Orientierung erhalten';
  } else {
    interp.textContent = 'Regulär — Orientierung umgekehrt';
  }
}

function formatNum(n) {
  if (Number.isInteger(n)) return n.toString();
  return parseFloat(n.toFixed(2)).toString();
}

// ─── Sarrus Canvas ───
function drawSarrus3x3(result) {
  const canvas = document.getElementById('sarrusCanvas');
  const dpr = window.devicePixelRatio || 1;

  const cellW = 58;
  const cellH = 52;
  const pad = 20;
  const cols = 5; // 3 + 2 repeated
  const rows = 3;

  const w = cols * cellW + pad * 2;
  const h = rows * cellH + pad * 2 + 10;

  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  // Background
  ctx.fillStyle = css('--bg-grouped');
  ctx.roundRect(0, 0, w, h, 12);
  ctx.fill();

  // Extended matrix: 3 cols + 2 repeated
  const m = getVal3;
  const extValues = [];
  for (let r = 0; r < 3; r++) {
    for (let c = 0; c < 5; c++) {
      extValues.push(m(r, c % 3));
    }
  }

  function cellCenter(row, col) {
    return {
      x: pad + col * cellW + cellW / 2,
      y: pad + row * cellH + cellH / 2 + 5
    };
  }

  // Draw diagonal lines
  if (activeStep >= 0 && activeStep < 6) {
    const s = result.steps[activeStep];
    const color = css(s.color);

    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.globalAlpha = 0.5;

    // Map step cells to extended grid positions
    let extCells;
    if (activeStep === 0) extCells = [[0,0],[1,1],[2,2]];
    else if (activeStep === 1) extCells = [[0,1],[1,2],[2,3]];
    else if (activeStep === 2) extCells = [[0,2],[1,3],[2,4]];
    else if (activeStep === 3) extCells = [[2,0],[1,1],[0,2]];
    else if (activeStep === 4) extCells = [[2,1],[1,2],[0,3]];
    else extCells = [[2,2],[1,3],[0,4]];

    ctx.beginPath();
    extCells.forEach(([r, c], i) => {
      const p = cellCenter(r, c);
      if (i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  // Draw separator line between col 2 and 3
  ctx.strokeStyle = css('--separator-strong');
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  const sepX = pad + 3 * cellW;
  ctx.beginPath();
  ctx.moveTo(sepX, pad);
  ctx.lineTo(sepX, h - pad);
  ctx.stroke();
  ctx.setLineDash([]);

  // Draw cells
  for (let r = 0; r < 3; r++) {
    for (let c = 0; c < 5; c++) {
      const p = cellCenter(r, c);
      const val = extValues[r * 5 + c];
      const isRepeated = c >= 3;

      // Check if cell is highlighted
      let isHighlighted = false;
      let highlightColor = null;

      if (activeStep >= 0 && activeStep < 6) {
        const s = result.steps[activeStep];
        let extCells;
        if (activeStep === 0) extCells = [[0,0],[1,1],[2,2]];
        else if (activeStep === 1) extCells = [[0,1],[1,2],[2,3]];
        else if (activeStep === 2) extCells = [[0,2],[1,3],[2,4]];
        else if (activeStep === 3) extCells = [[2,0],[1,1],[0,2]];
        else if (activeStep === 4) extCells = [[2,1],[1,2],[0,3]];
        else extCells = [[2,2],[1,3],[0,4]];

        for (const [er, ec] of extCells) {
          if (er === r && ec === c) {
            isHighlighted = true;
            highlightColor = css(s.color);
            break;
          }
        }
      }

      // Cell background
      if (isHighlighted) {
        ctx.fillStyle = highlightColor;
        ctx.globalAlpha = 0.15;
        ctx.beginPath();
        ctx.roundRect(p.x - cellW/2 + 4, p.y - cellH/2 + 4, cellW - 8, cellH - 8, 6);
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      // Value
      ctx.fillStyle = isHighlighted ? highlightColor :
                      isRepeated ? css('--text-tertiary') : css('--text-primary');
      ctx.font = `${isHighlighted ? '700' : '500'} ${isHighlighted ? '1.15rem' : '1rem'} -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(val.toString(), p.x, p.y);
    }
  }
}

// ─── Animation ───
function animateSarrus() {
  if (animating || matrixSize !== 3) return;

  readValues();
  animating = true;
  const btn = document.getElementById('animateBtn');
  btn.disabled = true;
  btn.textContent = 'Animiert …';

  activeStep = -1;
  const totalSteps = 6;
  let current = 0;

  function nextStep() {
    activeStep = current;
    updateCalculation();

    current++;
    if (current <= totalSteps) {
      setTimeout(nextStep, 700);
    } else {
      // Show all
      setTimeout(() => {
        activeStep = -1;
        updateCalculation();
        animating = false;
        btn.disabled = false;
        btn.textContent = 'Sarrus-Regel animieren';
      }, 500);
    }
  }

  nextStep();
}

// ─── Polyfill roundRect ───
if (!CanvasRenderingContext2D.prototype.roundRect) {
  CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
    if (typeof r === 'number') r = [r, r, r, r];
    this.moveTo(x + r[0], y);
    this.arcTo(x + w, y, x + w, y + h, r[1]);
    this.arcTo(x + w, y + h, x, y + h, r[2]);
    this.arcTo(x, y + h, x, y, r[3]);
    this.arcTo(x, y, x + w, y, r[0]);
    this.closePath();
  };
}

// ─── Dark mode listener ───
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => updateCalculation());

// ─── Init ───
buildUI();
</script>
</body>
</html>